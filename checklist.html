<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Device Maintenance CRUD</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--primary:#2563eb;--text:#0b1220}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:16px;background:var(--bg);color:var(--text)}
    h1{font-size:20px}
    table{width:100%;border-collapse:collapse;background:var(--card)}
    th,td{padding:8px;border:1px solid rgba(0,0,0,.06);font-size:13px}
    th{background:rgba(238,242,255,.9)}
    .controls{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .card{background:var(--card);padding:12px;border-radius:8px;box-shadow:0 1px 4px rgba(10,10,20,.06)}
    .form-row{display:flex;gap:8px;flex-wrap:wrap}
    label{display:flex;gap:6px;align-items:center}
    input[type=text],select,textarea{padding:6px;border:1px solid #ccc;border-radius:4px}
    .btn{padding:6px 8px;border-radius:6px;border:0;cursor:pointer}
    .btn-primary{background:var(--primary);color:white}
    .small{font-size:12px;padding:6px 8px}
    .checkbox-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
    @media(max-width:900px){.checkbox-grid{grid-template-columns:repeat(2,1fr)}}

    /* Offcanvas panel (right-side) */
    .offcanvas { position:fixed; top:0; right:-420px; width:400px; max-width:100%; height:100%; background:var(--card); box-shadow:-8px 0 24px rgba(0,0,0,.12); transition:right .28s ease; z-index:9999; display:flex; flex-direction:column; }
    .offcanvas.open { right:0; }
    .offcanvas .header{padding:12px;border-bottom:1px solid rgba(0,0,0,.06); display:flex;align-items:center;justify-content:space-between}
    .offcanvas .content{padding:12px;overflow:auto;flex:1}
    .check-item{margin:6px 0;display:flex;gap:8px;align-items:flex-start}
    .check-mark{font-size:16px;line-height:1}
    .muted{color:#6b7280;font-size:13px}
  </style>
</head>
<body>
  <h1>Device Maintenance ‚Äî CRUD (with Firebase Firestore)</h1>

  <div class="card">
    <div class="controls">
      <input id="search" placeholder="Search by Manufacturer/Model/Serial" style="flex:1;padding:8px;border-radius:6px;border:1px solid #d0d5ea" />
      <button class="btn btn-primary" id="btnNew">+ New Device</button>
      <button class="btn small" id="btnRefresh">Refresh</button>
    </div>

    <div id="formWrap" style="display:none;margin-bottom:12px" class="card">
      <form id="deviceForm">
        <input type="hidden" id="docId">
        <div class="form-row">
          <input id="srNo" placeholder="Sr. No" style="width:80px" />
          <input id="manufacturer" placeholder="Manufacturer" />
          <input id="model" placeholder="Model" />
          <input id="serial" placeholder="Serial Number" />
          <input id="ram" placeholder="RAM" />
          <input id="storage" placeholder="Storage" />
          <input id="processor" placeholder="Processor" />
        </div>

        <h4 style="margin-top:10px">Checklist</h4>
        <div class="checkbox-grid" id="checkboxes"></div>

        <div style="margin-top:8px">
          <label>Remarks: <textarea id="remarks" rows="2" style="width:100%;"></textarea></label>
        </div>

        <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
          <button type="button" class="btn" id="btnCancel">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>

    <div style="overflow:auto;max-height:60vh">
      <table id="devicesTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Manufacturer</th>
            <th>Model</th>
            <th>Serial</th>
            <th>RAM</th>
            <th>Storage</th>
            <th>Processor</th>
            <th>Remarks</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Offcanvas checklist panel -->
  <div id="offcanvas" class="offcanvas" aria-hidden="true">
    <div class="header">
      <strong>Checklist</strong>
      <div>
        <button class="btn" id="closeOff">Close</button>
      </div>
    </div>
    <div class="content" id="offContent">
      <!-- checklist items inserted here -->
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyA5ezNWECVn4vkdEHWhap-mv1B-D8LCN70",
      authDomain: "quiz-43b3e.firebaseapp.com",
      projectId: "quiz-43b3e",
      storageBucket: "quiz-43b3e.appspot.com",
      messagingSenderId: "477037762591",
      appId: "1:477037762591:web:ea30670a704b0063819d2a",
      measurementId: "G-7RWKDV2SLP"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const collectionRef = db.collection('devices');

    const CHECKLIST = [
      'Install Windows (latest)', 'Install all drivers & BIOS update', 'Run Windows Update', 'Install Office 2016',
      'Install Acrobat Reader', 'Install WinRAR', 'Install Chrome', 'Install Firefox', 'Install Kaspersky', 'Install VLC',
      'Keyboard', 'Touchpad', 'USB ports', 'VGA', 'HDMI', 'Display Port', 'LAN', 'WiFi', 'Speaker', 'Audio', 'Microphone',
      'Display Screen', 'Hinges'
    ];

    // build checkboxes
    const checkboxWrap = document.getElementById('checkboxes');
    CHECKLIST.forEach(key => {
      const id = 'chk_' + key.replace(/[^a-z0-9]+/gi,'_');
      const label = document.createElement('label');
      const input = document.createElement('input');
      input.type = 'checkbox'; input.id = id;
      label.appendChild(input);
      label.appendChild(document.createTextNode(' ' + key));
      checkboxWrap.appendChild(label);
    });

    // UI refs
    const btnNew = document.getElementById('btnNew');
    const formWrap = document.getElementById('formWrap');
    const deviceForm = document.getElementById('deviceForm');
    const tbody = document.querySelector('#devicesTable tbody');
    const btnCancel = document.getElementById('btnCancel');
    const search = document.getElementById('search');
    const btnRefresh = document.getElementById('btnRefresh');
    const offcanvas = document.getElementById('offcanvas');
    const offContent = document.getElementById('offContent');
    const closeOff = document.getElementById('closeOff');

    btnNew.addEventListener('click', ()=> openForm());
    btnCancel.addEventListener('click', closeForm);
    btnRefresh.addEventListener('click', loadDevicesOnce);
    closeOff.addEventListener('click', closeOffcanvas);

    function openForm(data){
      formWrap.style.display = 'block';
      if(data){
        document.getElementById('docId').value = data._id || '';
        document.getElementById('srNo').value = data.srNo || '';
        document.getElementById('manufacturer').value = data.manufacturer || '';
        document.getElementById('model').value = data.model || '';
        document.getElementById('serial').value = data.serial || '';
        document.getElementById('ram').value = data.ram || '';
        document.getElementById('storage').value = data.storage || '';
        document.getElementById('processor').value = data.processor || '';
        document.getElementById('remarks').value = data.remarks || '';
        CHECKLIST.forEach(k=>{
          const id = 'chk_'+k.replace(/[^a-z0-9]+/gi,'_');
          const el = document.getElementById(id); if(el) el.checked = !!(data.checklist && data.checklist[k]);
        });
      } else {
        deviceForm.reset(); document.getElementById('docId').value = '';
        CHECKLIST.forEach(k=>{ const id='chk_'+k.replace(/[^a-z0-9]+/gi,'_'); const el=document.getElementById(id); if(el) el.checked=false; });
      }
    }
    function closeForm(){ formWrap.style.display='none'; deviceForm.reset(); document.getElementById('docId').value=''; }

    deviceForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const id = document.getElementById('docId').value;
      const payload = {
        srNo: document.getElementById('srNo').value || null,
        manufacturer: document.getElementById('manufacturer').value || '',
        model: document.getElementById('model').value || '',
        serial: document.getElementById('serial').value || '',
        ram: document.getElementById('ram').value || '',
        storage: document.getElementById('storage').value || '',
        processor: document.getElementById('processor').value || '',
        remarks: document.getElementById('remarks').value || '',
        checklist: {}
      };
      CHECKLIST.forEach(k=>{ const id='chk_'+k.replace(/[^a-z0-9]+/gi,'_'); const el=document.getElementById(id); payload.checklist[k]=!!(el && el.checked); });

      try{
        const now = new Date().toLocaleString();
        if(!payload.date) payload.date = now;
        payload.modified = now;
        if(id) await collectionRef.doc(id).set(payload,{merge:true}); else await collectionRef.add(payload);
        closeForm();
      } catch(err){ alert('Save failed: '+err.message); }
    });

    // format checklist for offcanvas (checked items only)
    function formatChecklistForPanel(checklist){
      if(!checklist) return '<div class="muted">No items checked.</div>';
      const done = Object.entries(checklist).filter(([k,v])=>v).map(([k])=>k);
      if(done.length===0) return '<div class="muted">No items checked.</div>';
      return done.map(d=>`<div class="check-item"><div class="check-mark">‚úîÔ∏è</div><div>${escapeHtml(d)}</div></div>`).join('');
    }

    // open offcanvas by doc id
    async function openOffcanvasById(id){
      try{
        const doc = await collectionRef.doc(id).get();
        if(!doc.exists){ offContent.innerHTML = '<div class="muted">Record not found.</div>'; openOffcanvas(); return; }
        const data = doc.data();
        offContent.innerHTML = '';
        // header area: show basic info
        const header = document.createElement('div');
        header.innerHTML = `<div style="margin-bottom:8px"><strong>${escapeHtml(data.manufacturer||'')} ${escapeHtml(data.model||'')}</strong><div class="muted">SN: ${escapeHtml(data.serial||'')}</div></div>`;
        offContent.appendChild(header);
        // checklist
        const checklistHtml = formatChecklistForPanel(data.checklist || {});
        const checklistWrap = document.createElement('div');
        checklistWrap.innerHTML = checklistHtml;
        offContent.appendChild(checklistWrap);
        // remarks
        if(data.remarks) { const r = document.createElement('div'); r.style.marginTop='12px'; r.innerHTML = `<strong>Remarks</strong><div>${escapeHtml(data.remarks)}</div>`; offContent.appendChild(r); }
        openOffcanvas();
      } catch(e){ offContent.innerHTML = '<div class="muted">Failed to load checklist.</div>'; openOffcanvas(); }
    }

    function openOffcanvas(){ offcanvas.classList.add('open'); offcanvas.setAttribute('aria-hidden','false'); }
    function closeOffcanvas(){ offcanvas.classList.remove('open'); offcanvas.setAttribute('aria-hidden','true'); }

    // render table
    function renderSnapshot(items){
      const q = search.value.trim().toLowerCase();
      const filtered = items.filter(it=>{
        if(!q) return true;
        return (it.manufacturer||'').toLowerCase().includes(q) || (it.model||'').toLowerCase().includes(q) || (it.serial||'').toLowerCase().includes(q);
      });
      tbody.innerHTML = '';
      filtered.forEach(it=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(it.srNo||'')}</td>
          <td>${escapeHtml(it.manufacturer||'')}</td>
          <td>${escapeHtml(it.model||'')}</td>
          <td>${escapeHtml(it.serial||'')}</td>
          <td>${escapeHtml(it.ram||'')}</td>
          <td>${escapeHtml(it.storage||'')}</td>
          <td>${escapeHtml(it.processor||'')}</td>
          <td>${escapeHtml(it.remarks||'')}</td>
          <td>
            <button class="btn small" onclick="openOffcanvasById('${it._id}')">üëÅÔ∏è View</button>
            <button class="btn small" onclick="editDevice('${it._id}')">Edit</button>
            <button class="btn small" onclick="deleteDevice('${it._id}')">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // escape
    function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // firestore listeners
    let unsubscribe = null;
    function listenDevices(){ if(unsubscribe) unsubscribe(); unsubscribe = collectionRef.orderBy('srNo').onSnapshot(snapshot=>{ renderSnapshot(snapshot.docs.map(d=>({ _id:d.id, ...d.data() }))); }, err=>{ console.error(err); loadDevicesOnce(); }); }
    async function loadDevicesOnce(){ try{ const snap = await collectionRef.orderBy('srNo').get(); renderSnapshot(snap.docs.map(d=>({ _id:d.id, ...d.data() }))); } catch(e){ console.error(e); } }

    // edit/delete
    window.editDevice = async function(id){ const doc = await collectionRef.doc(id).get(); if(!doc.exists){ alert('Document not found'); return; } openForm({ _id:id, ...doc.data() }); }
    window.deleteDevice = async function(id){ if(!confirm('Delete this device?')) return; try{ await collectionRef.doc(id).delete(); } catch(e){ alert('Delete failed: '+e.message); } }

    search.addEventListener('input', ()=> loadDevicesOnce());

    // init
    listenDevices();

  </script>
</body>
</html>
