<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>System Info Dashboard</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    h1 { color: #333; }
    table { border-collapse: collapse; width: 100%; background: #fff; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
    th { background: #007ACC; color: white; }
    button { padding: 5px 10px; margin: 2px; cursor: pointer; border: none; }
    .delete-btn { background: #E74C3C; color: white; }
    .edit-btn { background: #F1C40F; color: white; }
    .export-btn { background: #2ECC71; color: white; }
    .clear-btn { background: #8E44AD; color: white; }
</style>
</head>
<body>

<h1>System Info Dashboard</h1>
<div style="margin-bottom:10px;">
    <button class="export-btn" onclick="exportToExcelJS()">Export to Excel</button>
    <button class="clear-btn" onclick="deleteCollection()">Delete Entire Collection</button>
</div>

<table id="systemTable">
    <thead>
        <tr>
            <th>Client Name</th>
            <th>Username</th>
            <th>Logged In User</th>
            <th>Manufacturer</th>
            <th>Model</th>
            <th>OS</th>
            <th>Version</th>
            <th>Architecture</th>
            <th>Processor</th>
            <th>RAM</th>
            <th>Storage</th>
            <th>Serial</th>
            <th>Timestamp</th>
            <th>Remarks</th> <!-- Second-last column -->
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver/dist/FileSaver.min.js"></script>

<script>
const projectId = "quiz-43b3e";  
const collection = "systemInfo";
const baseUrl = `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents/${collection}`;

let currentData = [];

// Standard sizes
const ramSizes = [8, 16, 32, 64, 128, 256]; // GB
const storageSizes = [128, 240, 256, 512, 1024]; // GB

function adjustRAM(value) {
    if (!value) return "";
    const num = parseFloat(value);
    for (let size of ramSizes) {
        if (num <= size) return size + "GB";
    }
    return ramSizes[ramSizes.length - 1] + "GB";
}

function adjustStorage(value) {
    if (!value) return "";
    let num = parseFloat(value) + 40; // +40 GB
    let nearest = storageSizes[0];
    for (let size of storageSizes) {
        if (size <= num) nearest = size;
    }
    return nearest >= 1024 ? (nearest / 1024) + "TB" : nearest + "GB";
}

async function fetchData() {
    const res = await fetch(baseUrl);
    const data = await res.json();
    currentData = data.documents || [];
    const tbody = document.querySelector("#systemTable tbody");
    tbody.innerHTML = "";

    if (!currentData.length) return;

    currentData.forEach(doc => {
        const fields = doc.fields;
        const tr = document.createElement("tr");

        const keys = ["clientName","username","loggedInUser","manufacturer","model",
                      "osName","OSDisplayVersion","architecture","processor","ramGB","storage","serial","timestamp"];
        
        keys.forEach(key => {
            const td = document.createElement("td");
            if(key === "ramGB") td.textContent = adjustRAM(fields[key]?.stringValue);
            else if(key === "storage") td.textContent = adjustStorage(fields[key]?.stringValue);
            else td.textContent = fields[key]?.stringValue || "";
            tr.appendChild(td);
        });

        // Remarks as second last column
        const remarksTd = document.createElement("td");
        remarksTd.textContent = fields.remarks?.stringValue || "";
        tr.appendChild(remarksTd);

        // Actions
        const actionTd = document.createElement("td");
        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.className = "edit-btn";
        editBtn.onclick = () => editRecord(doc.name, fields);
        actionTd.appendChild(editBtn);

        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.className = "delete-btn";
        delBtn.onclick = () => deleteRecord(doc.name);
        actionTd.appendChild(delBtn);

        tr.appendChild(actionTd);
        tbody.appendChild(tr);
    });
}

async function deleteRecord(docName) {
    if (!confirm("Are you sure you want to delete this record?")) return;
    try {
        await fetch(`https://firestore.googleapis.com/v1/${docName}`, { method: "DELETE" });
        alert("Record deleted!");
        fetchData();
    } catch (e) {
        alert("Failed to delete record: " + e);
    }
}

function editRecord(docName, fields) {
    const newRemarks = prompt("Edit Remarks:", fields.remarks?.stringValue || "");
    if (newRemarks === null) return;

    const body = { fields: { ...fields, remarks: { stringValue: newRemarks } } };

    fetch(`https://firestore.googleapis.com/v1/${docName}?currentDocument.exists=true`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
    })
    .then(() => { alert("Record updated!"); fetchData(); })
    .catch(err => alert("Failed to update record: " + err));
}

async function deleteCollection() {
    const pin = prompt("Enter secret PIN to delete entire collection:");
    if(pin !== "Delete This Collection") return alert("Incorrect PIN. Access denied.");

    if (!confirm("Are you sure you want to delete the entire collection?")) return;
    try {
        for (const doc of currentData) {
            await fetch(`https://firestore.googleapis.com/v1/${doc.name}`, { method: "DELETE" });
        }
        alert("Collection deleted!");
        fetchData();
    } catch (e) {
        alert("Failed to delete collection: " + e);
    }
}

// ----- ExcelJS Export -----
async function exportToExcelJS() {
    if (!currentData.length) return alert("No data to export.");

    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('System Info');

    worksheet.columns = [
        { header: 'Client Name', key: 'clientName', width: 20 },
        { header: 'Username', key: 'username', width: 20 },
        { header: 'Logged In User', key: 'loggedInUser', width: 20 },
        { header: 'Manufacturer', key: 'manufacturer', width: 20 },
        { header: 'Model', key: 'model', width: 20 },
        { header: 'OS', key: 'osName', width: 20 },
        { header: 'Version', key: 'osVersion', width: 15 },
        { header: 'Architecture', key: 'architecture', width: 15 },
        { header: 'Processor', key: 'processor', width: 25 },
        { header: 'RAM', key: 'ramGB', width: 10 },
        { header: 'Storage', key: 'storage', width: 15 },
        { header: 'Serial', key: 'serial', width: 20 },
        { header: 'Timestamp', key: 'timestamp', width: 20 },
        { header: 'Remarks', key: 'remarks', width: 30 },
    ];

    currentData.forEach(row => {
        const f = row.fields;
        worksheet.addRow({
            clientName: f.clientName?.stringValue || "",
            username: f.username?.stringValue || "",
            loggedInUser: f.loggedInUser?.stringValue || "",
            manufacturer: f.manufacturer?.stringValue || "",
            model: f.model?.stringValue || "",
            osName: f.osName?.stringValue || "",
            osVersion: f.OSDisplayVersion?.stringValue || "",
            architecture: f.architecture?.stringValue || "",
            processor: f.processor?.stringValue || "",
            ramGB: adjustRAM(f.ramGB?.stringValue),
            storage: adjustStorage(f.storage?.stringValue),
            serial: f.serial?.stringValue || "",
            timestamp: f.timestamp?.stringValue || "",
            remarks: f.remarks?.stringValue || "",
        });
    });

    worksheet.getRow(1).eachCell(cell => {
        cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF007ACC' } };
        cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
        cell.alignment = { vertical: 'middle', horizontal: 'center' };
    });

    worksheet.eachRow((row, rowNumber) => {
        if (rowNumber === 1) return;
        const fillColor = rowNumber % 2 === 0 ? 'FFE0F7FA' : 'FFFFFFFF';
        row.eachCell(cell => {
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: fillColor } };
            cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
        });
    });

    worksheet.views = [{ state: 'frozen', ySplit: 1 }];

    workbook.xlsx.writeBuffer().then(buffer => {
        const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
        saveAs(blob, "Advanced_System_Info.xlsx");
    });
}

// Load table on page load
fetchData();
</script>
</body>
</html>
